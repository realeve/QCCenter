var ec=[],search=function(){function a(a,e){var t=parseInt(a,10)-parseInt(e,10);return t<0&&(t+=1e4),t++,t}function t(){f.cart=$('[name="cart"]').val().trim().toUpperCase(),f.codeNo=$('[name="codeNo"]').val().trim(),f.paperNo=$('[name="paperNo"]').val().trim()}function n(a){f.type=judgeSearchType(f.cart),"undefined"==typeof a?f.updateHisInfo=!0:f.updateHisInfo=a;var e=!1;switch(f.type){case config.search.ERR:bsTips("请输入有效的车号或冠字信息"),e=!0;break;case config.search.GZ:""===f.prod?(bsTips("冠字号查询需选择品种信息"),e=!0,$('[name="cart"]').val(f.cart)):k(f);break;case config.search.CART:""!==f.codeNo&&4==f.codeNo.length?f.type=config.search.CODENO:""!==f.paperNo&&4==f.paperNo.length&&(f.type=config.search.PAPERNO),k(f);break;case config.search.CODE:break;case config.search.REEL:window.location.href="/search/paper#"+f.cart}e&&$('[name="querySetting"]').click(),bsTips("数据加载完毕",1)}function r(){var a=today(1).replace(" ","T")+"+08",e='<div class="note note-danger margin-top-30"> <h4>该万产品未搜索到相关车号信息 <p class="margin-top-10">\t\t\t<i class="fa fa-pencil"></i> <span>质量控制中心  发表于 <span name="isodate" title="'+a+'"></span> </span>\t\t</p></h4></div>';$('[name="prodInfo"]').html(e),$("[name=isodate]").prettyDate({interval:1e4})}function o(){var a="<h4> 该万产品未搜索到相关信息 </h4>";r(),$('[name="cartName"]').text(f.cart),$('[name="cartInfo"]').html(""),$("[name=qualityLine]").hide(),$('[name="hisCartList"]').hide(),$("[name=storageInfo]").hide(),$("#intaglio").html(""),$("#offset").html(""),$('[name="mahouInfo"]').html(a),$('[name="mahouImg"]').html(""),"undefined"!=typeof ec[1]&&ec[1].dispose(),$('[name="screenInfo"]').html(a),$('[name="siyinImg"]').html(a),$('[name="imgVerifyInfo"]').html(a),$("#ocr").html(a),$("#ananysis1").html(a),$("#ananysis2").html(""),$("#ananysis3").html(""),$("#ananysis4").html(""),$("#ananysis5").html("")}function i(a){"8"==a.substring(3,2)?($("#portlet_tab1").removeClass("hidden"),$('[href="#portlet_tab1"]').parent().removeClass("hidden")):$("#portlet_tab1").hasClass("hidden")||($("#portlet_tab1").addClass("hidden"),$('[href="#portlet_tab1"]').parent().addClass("hidden"))}function c(a,e){var t={start:"",end:""};return a.map(function(a){var n=jsLeft(a.ProcName,1);e==n&&(t.end=a.StartDate,""===t.start&&(t.start=a.StartDate))}),""!==t.start&&(t={start:t.start.split(" ")[0].replace(/-/g,""),end:t.end.split(" ")[0].replace(/-/g,"")}),t}function s(a){var t=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&M=3&blob=1&t="+a.cartID+"&ID="+(a.imgType?254:289)+"&cache=14400";$.ajax({url:t}).done(function(e){for(var t=handleAjaxData(e),n={data:[]},r=a.imgType?4:3,o=0;o<3;o++){var i=a.start+o*r;n.data.push({mac:a.data[i],pos:a.data[i+1],num:a.data[i+2],img:t.data[0][o],type:a.imgType?a.data[i+3]:"0"})}tpl.render("imglist.etpl",n,a.el)}).fail(function(){console.log("read data error:<br>"),console.log(e.responseText)})}function l(a){var e=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&M=3&ID=312&cart="+a;$.ajax({url:e}).done(function(a){a=$.parseJSON(a);var e=w(a.data);ec[2]=echarts.init(document.getElementById("codeFakeType")),ec[2].setOption(e)})}function d(){f.cart=window.location.hash.replace("#",""),""!==f.cart&&n()}function p(a){f.cart=a.val().toUpperCase(),""!==f.cart&&(location.hash=f.cart)}var h=function(a,e){function t(a){if(a=a.toUpperCase(),"A"==a)return"Z";var e=a.charCodeAt()-1;return String.fromCharCode(e)}function n(a,e){return e=e||4,a="000"+a,jsRight(a,e)}function r(a,e){var r={num:parseInt(a.replace(/[A-Za-z]/g,""),10),alpha:a.replace(/[0-9]/g,"").toUpperCase(),kNum:"9602A"==e||"9603A"==e?40:35},o={start:r.num-r.kNum,end:r.num},i={start:r.alpha[0],end:r.alpha[1]},c={start:r.alpha[0],end:r.alpha[1]};return o.start2=o.start,o.end2=o.end,o.start<0&&(o.start+=1e4,o.end=9999,o.start2=0,i.end=t(i.end),"A"==c.end&&(i.start=t(i.start))),{alpha:i,start:n(o.start),end:n(o.end),alpha2:c,start2:n(o.start2),end2:n(o.end2),codeNum:r.num}}function o(a,e){for(var t="",n=0;n<e;n++)t+="*";return a.start+t+a.end}for(var i=r(a,e),c=[/^[A-Za-z]{2}\d{4}$/,/^[A-Za-z]\d[A-Za-z]\d{3}$/,/^[A-Za-z]\d{2}[A-Za-z]\d{2}$/],s=0;s<3;s++)if(c[s].test(a)){i.alpha=o(i.alpha,s),i.alpha2=o(i.alpha2,s);break}return i},f={prod:"",cart:"",codeNo:"",paperNo:"",type:0},m={},u=function(a){var e=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=285&M=3&cart="+a+"&cache=1440";$.ajax({url:e}).done(function(a){a=handleAjaxData(a),a.showHead=1,tpl.render("simpleTable.etpl",a,$('[name="storageInfo"]'))}).fail(function(a){console.log("read data error:<br>"),console.log(a.responseText)})},g=function(a){var e=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=282&M=3&cart="+a+"&cache=1440";$.ajax({url:e}).done(function(a){if(a=handleAjaxData(a),0===a.rows)return $("[name=qualityLine]").hide(),void $('[name="hisCartList"]').hide();$("[name=qualityLine]").show(),$('[name="hisCartList"]').show();var e={xAxis:[],yAxis:[],type:"line"};a.data.map(function(a){e.xAxis.push(a[1]),e.yAxis.push(a[2])}),ec[0]=echarts.init(document.getElementById("chart"));var t=getSimpleEChart(e);ec[0].setOption(t),tpl.render("search/hisCartList.etpl",a,$('[name="hisCartList"]'))})},y=function(a){var t=a[0].CartNumber.trim(),n=t.substring(3,2);t=encodeURI("%")+jsRight(t,3)+encodeURI("%");var r=c(a,"胶"),o=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&M=3&cart="+t+"&prod="+n,i="&tstart="+r.start+"&tend="+r.end+"&ID=";$.ajax({url:o+i+"287&cache=1440"}).done(function(a){tpl.render("simpleTable.etpl",handleAjaxData(a),$("#offset"))}).fail(function(){console.log("read data error:<br>"),console.log(e.responseText)}),r=c(a,"凹"),i="&tstart="+r.start+"&tend="+r.end+"&ID=",$.ajax({url:o+i+"286&cache=1440"}).done(function(a){tpl.render("simpleTable.etpl",handleAjaxData(a),$("#intaglio"))}).fail(function(){console.log("read data error:<br>"),console.log(e.responseText)})},v=function(a){if(i(a),"8"===a.substring(3,2)){var t=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=288&M=3&cart="+a;$.ajax({url:t}).done(function(a){if(a=handleAjaxData(a),0===a.rows)return $('[name="screenInfo"]').html("<h4> 该万产品未搜索到相关信息 </h4>"),void $('[name="siyinImg"]').html("");var e={title:a.title,rows:a.rows,cols:a.cols,source:a.source,header:a.header.slice(1,11),data:[]};e.data.push(a.data[0].slice(1,11)),tpl.render("search/screenQuality.etpl",e,$('[name="screenInfo"]')),s({data:a.data[0],start:11,imgType:0,cartID:a.data[0][0],el:$('[name="siyinImg"]')})}).fail(function(){console.log("read data error:<br>"),console.log(e.responseText)})}},I=function(a){for(var e={xAxis:[],yAxis:[],type:"bar"},t=28;t<37;t++)e.xAxis.push(a.header[t].title),e.yAxis.push(a.data[0][t]);ec[1]=echarts.init(document.getElementById("mahouChart"));var n=getSimpleEChart(e,1);n.tooltip.formatter="{b}路:{c}条",delete n.yAxis.max,ec[1].setOption(n)},T=function(a){var t=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=290&M=3&cart="+a+"&cache="+config.cache;$.ajax({url:t}).done(function(a){if(a=handleAjaxData(a),0===a.rows)return $('[name="mahouInfo"]').html("<h4> 该万产品未搜索到相关信息 </h4>"),$('[name="mahouImg"]').html(""),void("undefined"!=typeof ec[1]&&ec[1].dispose());s({data:a.data[0],start:16,imgType:1,cartID:a.data[0][0],el:$('[name="mahouImg"]')}),I(a);var e={title:a.title,rows:a.rows,cols:a.cols,source:a.source,header:a.header.slice(1,15),noScroll:1,data:[]};e.data.push(a.data[0].slice(1,15)),tpl.render("simpleTable.etpl",e,$('[name="mahouInfo"]'))}).fail(function(){console.log("read data error:<br>"),console.log(e.responseText)})},b=function(a){var e=$('[name="imgVerifyInfo"]'),t=292,n=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID="+t+"&M=3&cart="+a+"&cache="+config.cache;$.ajax({url:n}).done(function(t){t=$.parseJSON(t),e.html(tpl.getHTML("simpleTable.etpl",t)),e.find(".scroller").attr("style"," ").append('<a href="../search/image#'+a+'" target="_blank" class="cbp-l-project-details-visit btn red uppercase">实废图像</a>')})},x=function(a){var e=$("#ocr"),t=293,n=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID="+t+"&M=3&cart="+a+"&cache="+config.cache;tpl.renderTable(e,n)},D=function(a){var e=$("#ananysis"),t=[{start:0,end:10,dom:$("#ananysis1"),title:"1.综述",showHead:!0,direction:"ver",class:"col-md-6",repeat:{switch:!1}},{start:11,end:24,dom:$("#ananysis2"),title:"2.胶印工序",showHead:!0,direction:"ver",repeat:{switch:!0,start:0,end:2},class:"col-md-6"},{start:25,end:32,dom:$("#ananysis3"),title:"3.凹印工序",showHead:!0,direction:"ver",repeat:{switch:!0,start:0,end:2},class:"col-md-6"},{start:33,end:42,dom:$("#ananysis4"),title:"4.其它",showHead:!0,direction:"ver",repeat:{switch:!0,start:0,end:2},class:"col-md-6"},{start:43,end:49,dom:$("#ananysis5"),title:"5.人工裁切评分",showHead:!0,direction:"ver",repeat:{switch:!0,start:0,end:2},class:"col-md-6"}],n=294,r=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID="+n+"&M=3&cart="+a+"&cache="+config.cache;tpl.renderTable(e,r,t)},A=function(a){T(a),f.updateHisInfo&&g(a),f.type==config.search.CODENO||f.type==config.search.PAPERNO,u(a),b(a),v(a),x(a),D(a),l(a)},w=function(a){function e(a){return Array.from(new Set(a))}var t=[],n=[],r=[],o=[];a.map(function(a){n.push(a[1]),t.push(a[0])}),t=e(t).reverse(),n=e(n),t.map(function(a){r[a]=[]}),a.map(function(a){r[a[0]][a[1]]=a[2]}),t=t.map(function(a){o.push({type:"bar",stack:"合计",barMaxWidth:25,name:a,data:[]});var e=o.length-1;return n.map(function(t){var n="undefined"==typeof r[a][t]?0:r[a][t];o[e].data.push(n)}),{name:a,icon:"circle"}});var i={tooltip:{trigger:"item"},color:["#61A5E8","#7ECF51"],legend:{data:t,x:"right",y:"10"},xAxis:{type:"category",boundaryGap:!0,data:n,axisTick:{show:!1},axisLine:{show:!1},show:!0},grid:{x:50,y:10,x2:10,y2:20},yAxis:{type:"value",axisTick:{show:!1},axisLine:{show:!1}},series:o};return i},N=function(a){m={},$('[name="cartName"]').text(a.data[0].CartNumber),m=a.data[0],m.imgUrl=getRootPath(1)+"/search/fakeImg/#"+m.CartNumber,a.data.map(function(e,t){a.data[t].WeekDay=getWeekdayByDate(e.StartDate),a.data[t].DateTitle=e.StartDate.replace(" ","T")+"+08"}),tpl.render("search/prodinfo.etpl",a,$('[name="prodInfo"]')),tpl.render("search/cartinfo.etpl",m,$('[name="cartInfo"]')),y(a.data)},k=function(e){var t,n,r=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=";if(e.type==config.search.GZ){var i=h(e.cart,e.prod);if(t=r+284+"&M=0&prod="+e.prod+"&alpha="+i.alpha+"&start="+i.start+"&end="+i.end+"&alpha2="+i.alpha2+"&start2="+i.start2+"&end2="+i.end2,n=ReadData(t),$("[name=prodNum]").html(n.rows),!(n.rows>0))return void o();n.data[0].kInfo=a(i.codeNum,n.data[0].GzNumber),A(n.data[0].CartNumber),N(n)}else t=r+283+"&M=0&cart="+e.cart+"&cache=1440",$.ajax({url:t}).done(function(a){return a=handleAjaxData(a),$("[name=prodNum]").html(a.rows),a.rows>0?(a.data[0].kInfo=0,void N(a)):void o()}),A(e.cart)},C=function(){$(".btn-theme-panel").removeClass("open"),t(),n()};return $(".theme-colors > li",".theme-panel").click(function(){f.prod=$(this).find("span").last().text(),$("ul > li",".theme-panel").removeClass("active"),$(this).addClass("active")}),$("#query").click(function(){C()}),$('a[href="#portlet_tab2"]').parent().click(function(){setTimeout(function(){ec[2]&&ec[2].resize()},0)}),$('a[href="#portlet_tab3"]').parent().click(function(){setTimeout(function(){ec[1]&&ec[1].resize()},0)}),$('.search-form [name="query"]').on("blur",function(){$('[name="cart"]').val($(this).val())}),$('input[name="cart"]').keydown(function(a){"Enter"===a.key&&($('[name="querySetting"]').click(),p($(this)))}),$(window).bind("hashchange",function(){f.cart=window.location.hash.replace("#","");var a=!$('[name=hiscart][href="#'+f.cart+'"]').length;n(a)}),{init:function(){hideSidebarTool(),$(".page-sidebar-wrapper").css("margin-top","0px"),$('[name="qualityLine"]').hide(),$('[name="hisCartList"]').hide();var a=["search/prodinfo.etpl","search/cartinfo.etpl","simpleTable.etpl","search/hisCartList.etpl","search/screenQuality.etpl","imglist.etpl"];tpl.init(a,d)}}}();jQuery(document).ready(function(){UIIdleTimeout.init(),initDom(),search.init(),bsTips("点击本页面工序名称将自动折叠面板")}),jQuery(window).resize(function(){for(var a=0;a<=2;a++)ec[a]&&ec[a].resize()});