var ec=[],search=function(){function a(a,t){var e=parseInt(a,10)-parseInt(t,10);return e<0&&(e+=1e4),++e}function t(){h.cart=$('[name="cart"]').val().trim().toUpperCase()}function e(a){h.type=judgeSearchType(h.cart),h.updateHisInfo=void 0===a||a;var t=!1;switch(h.type){case config.search.ERR:bsTips("请输入有效的车号或冠字信息"),t=!0;break;case config.search.GZ:""===h.prod?(bsTips("冠字号查询需选择品种信息"),t=!0,$('[name="cart"]').val(h.cart)):C(h);break;case config.search.CART:""!==h.codeNo&&4==h.codeNo.length?h.type=config.search.CODENO:""!==h.paperNo&&4==h.paperNo.length&&(h.type=config.search.PAPERNO),C(h);break;case config.search.CODE:break;case config.search.REEL:window.location.href="/search/paper#"+h.cart}t&&$('[name="querySetting"]').click(),bsTips("数据加载完毕",1)}function n(){var a='<div class="note note-danger margin-top-30"> <h4>该万产品未搜索到相关车号信息 <p class="margin-top-10">\t\t\t<i class="fa fa-pencil"></i> <span>质量控制中心  发表于 <span name="isodate" title="'+(today(1).replace(" ","T")+"+08")+'"></span> </span>\t\t</p></h4></div>';$('[name="prodInfo"]').html(a),$("[name=isodate]").prettyDate({interval:1e4})}function r(){var a="<h4> 该万产品未搜索到相关信息 </h4>";n(),$('[name="cartName"]').text(h.cart),$('[name="cartInfo"]').html(""),$("[name=qualityLine]").hide(),$('[name="hisCartList"]').hide(),$("[name=storageInfo]").hide(),$("#intaglio").html(""),$("#offset").html(""),$('[name="mahouInfo"]').html(a),$('[name="mahouImg"]').html(""),void 0!==ec[1]&&ec[1].dispose(),$('[name="screenInfo"]').html(a),$('[name="siyinImg"]').html(a),$('[name="imgVerifyInfo"]').html(a),$("#ocr").html(a),$("#ananysis1").html(a),$("#ananysis2").html(""),$("#ananysis3").html(""),$("#ananysis4").html(""),$("#ananysis5").html("")}function i(a){"8"==a.substring(3,2)?($("#portlet_tab1").removeClass("hidden"),$('[href="#portlet_tab1"]').parent().removeClass("hidden")):$("#portlet_tab1").hasClass("hidden")||($("#portlet_tab1").addClass("hidden"),$('[href="#portlet_tab1"]').parent().addClass("hidden"))}function o(a,t){var e={start:"",end:""};return a.map(function(a){var n=jsLeft(a.ProcName,1);t==n&&(e.end=a.StartDate,""===e.start&&(e.start=a.StartDate))}),""!==e.start&&(e={start:e.start.split(" ")[0].replace(/-/g,""),end:e.end.split(" ")[0].replace(/-/g,"")}),e}function c(a){var t=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&M=3&blob=1&t="+a.cartID+"&ID="+(a.imgType?254:289)+"&cache=14400";$.ajax({url:t}).done(function(t){for(var e=handleAjaxData(t),n={data:[]},r=a.imgType?4:3,i=0;i<3;i++){var o=a.start+i*r;n.data.push({mac:a.data[o],pos:a.data[o+1],num:a.data[o+2],img:e.data[0][i],type:a.imgType?a.data[o+3]:"0"})}tpl.render("imglist.etpl",n,a.el)}).fail(function(a){infoTips(handleError(a),0,$(".infotips"))})}function s(a){var t=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&M=3&ID=312&cart="+a;$.ajax({url:t}).done(function(a){if((a=$.parseJSON(a)).rows){var t=A(a.data);ec[2]=echarts.init(document.getElementById("codeFakeType")),ec[2].setOption(t)}}).error(function(a){infoTips(handleError(a),0,$(".infotips"))})}function d(){h.cart=window.location.hash.replace("#",""),""!==h.cart&&e()}function l(a){h.cart=a.val().toUpperCase(),""!==h.cart&&(location.hash=h.cart)}var p=function(a,t){function e(a){if("A"==(a=a.toUpperCase()))return"Z";var t=a.charCodeAt()-1;return String.fromCharCode(t)}function n(a,t){return t=t||4,a="000"+a,jsRight(a,t)}function r(a,t){for(var e="",n=0;n<t;n++)e+="*";return a.start+e+a.end}for(var i=function(a,t){var r={num:parseInt(a.replace(/[A-Za-z]/g,""),10),alpha:a.replace(/[0-9]/g,"").toUpperCase(),kNum:"9602A"==t||"9603A"==t?40:35},i={start:r.num-r.kNum,end:r.num},o={start:r.alpha[0],end:r.alpha[1]},c={start:r.alpha[0],end:r.alpha[1]};return i.start2=i.start,i.end2=i.end,i.start<0&&(i.start+=1e4,i.end=9999,i.start2=0,o.end=e(o.end),"A"==c.end&&(o.start=e(o.start))),{alpha:o,start:n(i.start),end:n(i.end),alpha2:c,start2:n(i.start2),end2:n(i.end2),codeNum:r.num}}(a,t),o=[/^[A-Za-z]{2}\d{4}$/,/^[A-Za-z]\d[A-Za-z]\d{3}$/,/^[A-Za-z]\d{2}[A-Za-z]\d{2}$/,/^[A-Za-z]\d{3}[A-Za-z]\d$/,/^[A-Za-z]\d{4}[A-Za-z]\$/],c=0;c<o.length;c++)if(o[c].test(a)){i.alpha=r(i.alpha,c),i.alpha2=r(i.alpha2,c);break}return i},h={prod:"",cart:"",codeNo:"",paperNo:"",type:0},f={},u=function(a){var t=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=285&M=3&cart="+a+"&cache=1440";$.ajax({url:t}).done(function(a){(a=handleAjaxData(a)).showHead=1,tpl.render("simpleTable.etpl",a,$('[name="storageInfo"]'))}).fail(function(a){infoTips(handleError(a),0,$(".infotips"))})},m=function(a){var t=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=282&M=3&cart="+a+"&cache=1440";$.ajax({url:t}).done(function(a){if(0===(a=handleAjaxData(a)).rows)return $("[name=qualityLine]").hide(),void $('[name="hisCartList"]').hide();$("[name=qualityLine]").show(),$('[name="hisCartList"]').show();var t={xAxis:[],yAxis:[],type:"line"};a.data.map(function(a){t.xAxis.push(a[1]),t.yAxis.push(a[2])}),ec[0]=echarts.init(document.getElementById("chart"));var e=getSimpleEChart(t);ec[0].setOption(e),tpl.render("search/hisCartList.etpl",a,$('[name="hisCartList"]'))}).fail(function(a){infoTips(handleError(a),0,$(".infotips"))})},g=function(a){var t=a[0].CartNumber.trim(),e=t.substring(3,2);t=encodeURI("%")+jsRight(t,3)+encodeURI("%");var n=o(a,"胶"),r=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&M=3&cart="+t+"&prod="+e,i="&tstart="+n.start+"&tend="+n.end+"&ID=";$.ajax({url:r+i+"287&cache=1440"}).done(function(a){tpl.render("simpleTable.etpl",handleAjaxData(a),$("#offset"))}).fail(function(a){infoTips(handleError(a),0,$(".infotips"))}),i="&tstart="+(n=o(a,"凹")).start+"&tend="+n.end+"&ID=",$.ajax({url:r+i+"286&cache=1440"}).done(function(a){tpl.render("simpleTable.etpl",handleAjaxData(a),$("#intaglio"))}).fail(function(a){infoTips(handleError(a),0,$(".infotips"))})},v=function(a){if(i(a),"8"===a.substring(3,2)){var t=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=288&M=3&cart="+a;$.ajax({url:t}).done(function(a){if(0===(a=handleAjaxData(a)).rows)return $('[name="screenInfo"]').html("<h4> 该万产品未搜索到相关信息 </h4>"),void $('[name="siyinImg"]').html("");var t={title:a.title,rows:a.rows,cols:a.cols,source:a.source,header:a.header.slice(1,11),data:[]};t.data.push(a.data[0].slice(1,11)),tpl.render("search/screenQuality.etpl",t,$('[name="screenInfo"]')),c({data:a.data[0],start:11,imgType:0,cartID:a.data[0][0],el:$('[name="siyinImg"]')})}).fail(function(a){infoTips(handleError(a),0,$(".infotips"))})}},y=function(a){for(var t={xAxis:[],yAxis:[],type:"bar"},e=28;e<37;e++)t.xAxis.push(a.header[e].title),t.yAxis.push(a.data[0][e]);ec[1]=echarts.init(document.getElementById("mahouChart"));var n=getSimpleEChart(t,1);n.tooltip.formatter="{b}路:{c}条",delete n.yAxis.max,ec[1].setOption(n)},T=function(a){var t=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=290&M=3&cart="+a+"&cache="+config.cache;$.ajax({url:t}).done(function(a){if(0===(a=handleAjaxData(a)).rows)return $('[name="mahouInfo"]').html("<h4> 该万产品未搜索到相关信息 </h4>"),$('[name="mahouImg"]').html(""),void(void 0!==ec[1]&&ec[1].dispose());c({data:a.data[0],start:16,imgType:1,cartID:a.data[0][0],el:$('[name="mahouImg"]')}),y(a);var t={title:a.title,rows:a.rows,cols:a.cols,source:a.source,header:a.header.slice(1,15),noScroll:1,data:[]};t.data.push(a.data[0].slice(1,15)),tpl.render("simpleTable.etpl",t,$('[name="mahouInfo"]'))}).fail(function(a){infoTips(handleError(a),0,$(".infotips"))})},I=function(a){var t=$('[name="imgVerifyInfo"]'),e=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=292&M=3&cart="+a+"&cache="+config.cache;$.ajax({url:e}).done(function(e){e=$.parseJSON(e),t.html(tpl.getHTML("simpleTable.etpl",e)),t.find(".scroller").append('<a href="../search/image#'+a+'" target="_blank" class="cbp-l-project-details-visit btn red uppercase">实废图像</a>')}).fail(function(a){infoTips(handleError(a),0,$(".infotips"))})},b=function(a){var t=$("#ocr"),e=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=293&M=3&cart="+a+"&cache="+config.cache;tpl.renderTable(t,e)},x=function(a){var t=$("#ananysis"),e=[{start:0,end:10,dom:$("#ananysis1"),title:"1.综述",showHead:!0,direction:"ver",class:"col-md-6",repeat:{switch:!1}},{start:11,end:24,dom:$("#ananysis2"),title:"2.胶印工序",showHead:!0,direction:"ver",repeat:{switch:!0,start:0,end:2},class:"col-md-6"},{start:25,end:32,dom:$("#ananysis3"),title:"3.凹印工序",showHead:!0,direction:"ver",repeat:{switch:!0,start:0,end:2},class:"col-md-6"},{start:33,end:42,dom:$("#ananysis4"),title:"4.其它",showHead:!0,direction:"ver",repeat:{switch:!0,start:0,end:2},class:"col-md-6"},{start:43,end:49,dom:$("#ananysis5"),title:"5.人工裁切评分",showHead:!0,direction:"ver",repeat:{switch:!0,start:0,end:2},class:"col-md-6"}],n=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=294&M=3&cart="+a+"&cache="+config.cache;tpl.renderTable(t,n,e)},N=function(a){T(a),h.updateHisInfo&&m(a),h.type==config.search.CODENO||(h.type,config.search.PAPERNO),u(a),I(a),v(a),b(a),x(a),s(a)},A=function(a){function t(a){return Array.from(new Set(a))}var e=[],n=[],r=[],i=[];return a.map(function(a){n.push(a[1]),e.push(a[0])}),e=t(e).reverse(),n=t(n),e.map(function(a){r[a]=[]}),a.map(function(a){r[a[0]][a[1]]=a[2]}),{tooltip:{trigger:"item"},color:["#61A5E8","#7ECF51"],legend:{data:e=e.map(function(a){i.push({type:"bar",stack:"合计",barMaxWidth:25,name:a,data:[]});var t=i.length-1;return n.map(function(e){var n=void 0===r[a][e]?0:r[a][e];i[t].data.push(n)}),{name:a,icon:"circle"}}),x:"right",y:"10"},xAxis:{type:"category",boundaryGap:!0,data:n,axisTick:{show:!1},axisLine:{show:!1},show:!0},grid:{x:50,y:10,x2:10,y2:20},yAxis:{type:"value",axisTick:{show:!1},axisLine:{show:!1}},series:i}},w=function(a){f={},$('[name="cartName"]').text(a.data[0].CartNumber),(f=a.data[0]).imgUrl=getRootPath(1)+"/search/image/#"+f.CartNumber,a.data.map(function(t,e){a.data[e].WeekDay=getWeekdayByDate(t.StartDate),a.data[e].DateTitle=t.StartDate.replace(" ","T")+"+08",a.data[e].datetime=t.StartDate.split(" ")[0].replace(/-/g,"")}),tpl.render("search/prodinfo.etpl",a,$('[name="prodInfo"]')),tpl.render("search/cartinfo.etpl",f,$('[name="cartInfo"]')),g(a.data)},D=function(a,t){var e;return $.ajax({async:!1,url:"http://10.8.1.25:100/api/333/76d8ab1aa9?cart="+a,success:function(a,t){e=a.data},error:function(a){console.log("read data error:<br>"),console.log(a.responseText)}}),0==e.length?t:(t.map(function(a){if(a.WorkInfo.length>0)return a;var t=e.find(function(t){return t.captain==a.CaptainName});return a.WorkInfo=null==t?"":t.comment_text,a}),t)},C=function(t){var e,n,i=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=";if(t.type==config.search.GZ){var o=p(t.cart,t.prod);e=i+284+"&M=0&prod="+t.prod+"&alpha="+o.alpha+"&start="+o.start+"&end="+o.end+"&alpha2="+o.alpha2+"&start2="+o.start2+"&end2="+o.end2,n=ReadData(e),$.ajax("http://10.8.1.25:100/api/332/5c91838515?prod="+t.prod+"&start="+t.cart+"&end="+t.cart).done(function(t){var e=t.data;if(0==n.rows&&e.length>0){var c=e[e.length-1].CartNumber;n=ReadData(i+283+"&M=0&cart="+c+"&cache=1440")}e.length>0&&(e=D(e[e.length-1].CartNumber,e)),n.rows=n.rows+e.length,n.data=n.data.concat(e);var s=n.data[n.data.length-1];if(n.data=n.data.map(function(a){return a.CarNumber=s.CarNumber,a.GzNumber=s.GzNumber,a.TechTypeName=s.TechTypeName,a}),$("[name=prodNum]").html(n.rows),n.rows>0){var d=n.data.length-1;n.data[d].kInfo=a(o.codeNum,n.data[d].GzNumber),N(n.data[d].CartNumber),w(n)}else r()})}else e=i+283+"&M=0&cart="+t.cart+"&cache=1440",$.ajax({url:e}).done(function(a){a=handleAjaxData(a),$.ajax("http://10.8.1.25:100/api/331/8ed6e81fa3/1440.html?cart="+t.cart).done(function(e){var n=e.data;n.length>0&&(n=D(t.cart,n)),a.rows=a.rows+n.length,a.data=a.data.concat(n);var i=a.data[a.data.length-1];a.data=a.data.map(function(a){return a.CarNumber=i.CarNumber,a.GzNumber=i.GzNumber,a.TechTypeName=i.TechTypeName,a}),$("[name=prodNum]").html(a.rows),a.rows>0?(a.data[0].kInfo=0,w(a)):r()})}).fail(function(a){infoTips(handleError(a),0,$(".infotips"))}),N(t.cart)},k=function(){$(".btn-theme-panel").removeClass("open"),t(),e()};return $(".theme-colors > li",".theme-panel").click(function(){h.prod=$(this).find("span").last().text(),$("ul > li",".theme-panel").removeClass("active"),$(this).addClass("active")}),$("#query").click(function(){k()}),$('a[href="#portlet_tab2"]').parent().click(function(){setTimeout(function(){ec[2]&&ec[2].resize()},0)}),$('a[href="#portlet_tab3"]').parent().click(function(){setTimeout(function(){ec[1]&&ec[1].resize()},0)}),$('.search-form [name="query"]').on("blur",function(){$('[name="cart"]').val($(this).val())}),$('input[name="cart"]').keydown(function(a){"Enter"===a.key&&($('[name="querySetting"]').click(),l($(this)))}),$(window).bind("hashchange",function(){h.cart=window.location.hash.replace("#",""),e(!$('[name=hiscart][href="#'+h.cart+'"]').length)}),{init:function(){hideSidebarTool(),$(".page-sidebar-wrapper").css("margin-top","0px"),$('[name="qualityLine"]').hide(),$('[name="hisCartList"]').hide();tpl.init(["search/prodinfo.etpl","search/cartinfo.etpl","simpleTable.etpl","search/hisCartList.etpl","search/screenQuality.etpl","imglist.etpl"],d)}}}();jQuery(document).ready(function(){UIIdleTimeout.init(),initDom(),search.init(),$(".page-bar").after('<div class="margin-top-10 infotips"></div>'),bsTips("点击本页面工序名称将自动折叠面板")}),jQuery(window).resize(function(){for(var a=0;a<=2;a++)ec[a]&&ec[a].resize()});