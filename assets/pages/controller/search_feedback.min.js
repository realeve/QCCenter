var feedback=function(){function e(e){var a=new JSZip;a.file("README.txt","这是一个由质量信息系统自动生成的图像压缩包");var t=a.folder("误废"),n=a.folder("实废"),r=a.folder("未判废"),i=$(".cbp-item");i.map(function(e,a){var i=$(a),o=a.innerText.split("\n"),c=[];c.push(o[2]),c.push(o[3].replace(/\//,"_").replace(/ /g,""));var l=c.join("_")+".jpg",s=i.find("img").attr("src").split("data:image/jpg;base64,")[1];i.hasClass("notfake")?t.file(l,s,{base64:!0}):i.hasClass("fake")?n.file(l,s,{base64:!0}):r.file(l,s,{base64:!0})}),a.generateAsync({type:"blob"}).then(function(a){saveAs(a,e+".zip")})}var a={},t=!1,n=function(){str=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=36&M=3&p=2&cache=14400",$.ajax({url:str}).done(function(e){e=handleAjaxData(e),InitSelect("machineID",e),$("[name=machineID] option").first().text("所有机台")});for(var e=100;e>0;e-=10)$("#limit").append("<option value="+e+">"+e+"</option>"),$("#errnum").append("<option value="+20*e+">"+20*e+"</option>");var a={machineID:-1,limit:70,errnum:1e3};"undefined"!=typeof localStorage.searchFeedBack?(a=$.parseJSON(localStorage.searchFeedBack),$("[name=machineID]").val(a.machineID),$("#limit").val(a.limit),"undefined"==typeof a.errnum?($("#errnum").val(1e3),a.errnum=1e3,i()):$("#errnum").val(a.errnum)):(localStorage.searchFeedBack=JSON.stringify(a),$("#limit").val(70),$("#errnum").val(1e3),$("[name=machineID]").val(-1)),c(a)},r=function(){return{machineID:$("[name=machineID]").val(),limit:$("#limit").val(),errnum:$("#errnum").val()}},i=function(){a=r(),localStorage.searchFeedBack=JSON.stringify(a)};$("#saveSettings").on("click",function(){i(),$(".page-quick-sidebar-toggler").click()});var o=function(e){var a="&ID=";return a+=e.machineID==-1?279:"280&mid="+e.machineID},c=function(e){e=e||r();var a=getDateRange(),t=getRootPath()+"/DataInterface/Api?Token="+config.TOKEN+"&M=0&tstart="+a.start+"&tend="+a.end+"&errnum1="+e.errnum+"&errnum2="+e.errnum+"&errnum3="+e.errnum+"&limit="+e.limit;t+=o(e);var n=ReadData(t);l(n)},l=function(e){function a(){if(i==e.rows){bsTips("图像数据载入完毕,共载入数据"+e.rows+"车",1);var a=$("#errnum").val();r=_.sortBy(r,["prod",function(e){return-parseInt(e.errnum,10)}]).map(function(e){if(parseInt(e.errnum,10)>a)return e.html}),$("#js-grid-juicy-projects").html(r.join("")),p()}}var t=[{class:"",filter:"none"},{class:"badge-info",filter:"notfake"},{class:"badge-danger",filter:"fake"}],n=getRootPath()+"/DataInterface/Api?Token="+config.TOKEN+"&blob=1&ID=254&cache=14400&M=3&t=";$("#js-grid-juicy-projects").html("");var r=[];if(e.rows>0){var i=0;e.data.map(function(e,o){var c=n+e.id;$.ajax({url:c}).done(function(n){n=handleAjaxData(n);for(var o,c=n.data[0],l=1;l<=3;l++)if("AA=="!=c[l-1]){var s=parseInt(e["ImgVerify"+l],10);s=s>2?2:s;var p={ProductName:e.ProductName,filter:t[s].filter,img:"data:image/jpg;base64,"+c[l-1],CartNumber:e.CartNumber,MachineName:e.MachineName,GoodRate:e.GoodRate,FormatPos:e["FormatPos"+l],imgType:t[s].class,ErrCount:e["ErrCount"+l]};o=tpl.getHTML("feedback/imgitem.etpl",p),r.push({html:o,prod:p.ProductName,errnum:p.ErrCount})}i++,a()})})}else $("#js-grid-juicy-projects").addClass("cbp-ready").append('<div class="cbp-search-nothing"><h3>当前时间范围内无相关信息</h3></div>')},s=function(){function e(e){url=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=291&M=0&cart="+e;var a=ReadData(url),t=["","badge-info","badge-danger"],n=a.data[0];n.imglist=[];for(var r=1;r<=3;r++){var i=parseInt(n["ImgVerify"+r],10);i=i>2?2:i,n.imglist.push({formatPos:n["FormatPos"+r],errCount:n["ErrCount"+r],verify:t[i]})}return{id:a.data[0].id,html:tpl.getHTML("feedback/detail.etpl",n)}}function a(e){url=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=281&M=3&mid="+e,$.ajax(url).done(function(e){e=handleAjaxData(e),tpl.render("feedback/prodinfo.etpl",e,$('[name="prodInfo"]'))})}function t(e,a){a.content.html(e),a.content.addClass("cbp-popup-content").removeClass("cbp-popup-content-basic"),a.wrap.addClass("cbp-popup-ready"),a.wrap.removeClass("cbp-popup-loading")}function n(e){var a={xAxis:[],yAxis:[]},t=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=282&M=3&cart="+e;$.ajax({url:t}).done(function(t){var n=handleAjaxData(t);tpl.render("feedback/hislist.etpl",n,$('[name="hislist"]')),n.data.map(function(t){i(t[0],t[1]==e),a.xAxis.push(t[1]),a.yAxis.push(t[2])}),a.type="line";var r=echarts.init(document.getElementById("chart")),o=getSimpleEChart(a);r.setOption(o)})}function r(e,a){var t=a.data[0][e];return t="AA=="==t?"../assets/global/img/none.png":"data:image/jpg;base64,"+t}function i(e,a){var t=getRootPath()+"/DataInterface/Api?Token="+config.TOKEN+"&blob=1&ID=254&cache=14400&M=3&t="+e;$.ajax({url:t}).done(function(t){t=$.parseJSON(t);var n=r(0,t);$('.cbp-popup-wrap [name="hisImg'+e+'"]').attr("src",n),a&&($('.cbp-popup-wrap [name="img'+e+'_0"]').attr("src",n),$('.cbp-popup-wrap [name="img'+e+'_1"]').attr("src",r(1,t)),$('.cbp-popup-wrap [name="img'+e+'_2"]').attr("src",r(2,t)))})}return{renderProdInfo:a,renderDetail:e,renderHisQua:n,render:t}}(),p=function(){var e=function(){$("#js-grid-juicy-projects").cubeportfolio({filters:"#js-filters-juicy-projects,#js-filters-juicy-projects2",search:"#js-search-blog-posts",layoutMode:"grid",defaultFilter:"*",animationType:"quicksand",gapHorizontal:35,gapVertical:30,gridAdjustment:"responsive",mediaQueries:[{width:1500,cols:7},{width:1100,cols:6},{width:800,cols:5},{width:480,cols:3},{width:320,cols:2}],caption:"overlayBottomReveal",displayType:"default",lightboxDelegate:".cbp-lightbox",lightboxGallery:!0,lightboxTitleSrc:"data-title",lightboxCounter:'<div class="cbp-popup-lightbox-counter">{{current}} of {{total}}</div>',singlePageDelegate:".cbp-singlePage",singlePageDeeplinking:!0,singlePageStickyNavigation:!0,singlePageCounter:'<div class="cbp-popup-singlePage-counter">{{current}} of {{total}}</div>',singlePageCallback:function(e,a){var t=this,n=s.renderDetail(e);s.render(n.html,t),s.renderProdInfo(n.id),s.renderHisQua(e)}},function(){bsTips("数据渲染完毕",1)})};t?$("#js-grid-juicy-projects").cubeportfolio("destroy",e):e(),t=!0};return $("#download").on("click",function(){var a,t=getDateRange();a="码后核查质量反馈("+t.start+"至"+t.end+")",e(a)}),{init:function(){var e=["feedback/imgitem.etpl","feedback/detail.etpl","feedback/prodinfo.etpl","feedback/hislist.etpl"];tpl.init(e,n),$(document).on("click",".ranges li:not(:last),button.applyBtn",function(){c()})}}}();jQuery(document).ready(function(){whiteBackground(),UIIdleTimeout.init(),initDashboardDaterange("YYYYMMDD"),initDom(0),feedback.init()});