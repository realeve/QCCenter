var MAIN_KEY="paper_cutRecord",cutWaste=function(){function e(){$('form input[type="text"]').eq(0).focus()}function a(){var e=$('[name="reelList"] tbody'),a=$('select[name="machine_id"]').val();if(null!=a&&""!=a&&-1!=a){var t=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=486&M=3&mid="+a;$.ajax({url:t}).done(function(a){function t(e,a){var t="<tr> <td>"+a+"</td>";return e.map(function(e){t+="  <td>"+e+"</td>"}),t+="</tr>"}if(0!=(a=handleAjaxData(a)).rows){var n="";a.data.map(function(e,a){n+=t(e,a+1)}),e.html(n)}else bsTips("当天无相关数据")})}else bsTips("请选择机台信息")}function t(){var e=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=24&M=3&t=1&cache=14400";$.ajax({url:e}).done(function(e){var a=handleAjaxData(e);InitSelect("prod_id",a)}),e=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=23&M=3&t=1&cache=14400",$.ajax({url:e}).done(function(e){var a=handleAjaxData(e);InitSelect("machine_id",a)}),initSelect2();var t=localStorage.getItem(MAIN_KEY+"cut_machine_id");null!=t&&setTimeout(function(){SetSelect2Val("machine_id",t),a()},1e3)}function n(){t(),$("input[name='reel_code']").maxlength({limitReachedClass:"label label-danger",threshold:3}),$(".page-header .dropdown-quick-sidebar-toggler").hide(),e()}function o(){var e=$('input[name="reel_code"]').val(),a=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=487&M=0&r="+e,t=ReadData(a);return 0==t.rows?0:($('input[name="reel_code"]').data("reelcode",e),t.header.map(function(e){var a=e.title;$('form .form-control[name="'+a+'"]').val(t.data[0][a])}),SetSelect2Val("prod_id",t.data[0].prod_id),SetSelect2Val("machine_id",t.data[0].machine_id),$('.portlet [type="submit"]').data("sn",t.data[0].id).html('更新  <i class="icon-cloud-upload"></i>'),i.updateMode=1,bsTips("历史数据载入成功",1),1)}function r(){var e=Math.floor((new Date).getHours()/8);$('[name="class_time"]').val(["夜班","白班","中班"][e]),"帕萨班"==GetSelect2Text("machine_id")&&($('[name="ream_69"]').val(0),$('[name="ream_49"]').val(0))}var i={initLoad:!0,updateMode:0};$('input[name="reel_code"]').on("blur",function(e){$(this).val().length>1?o()&&$('.portlet [type="submit"]').html('更新  <i class="icon-cloud-upload"></i>'):1==i.updateMode&&$(this).data("reelcode")!=$(this).val()&&$('.portlet [type="submit"]').html('提交  <i class="icon-cloud-upload"></i>')}),$('input[name="reel_code"]').on("keyup",function(){var e=$(this),a=jsRight(e.val(),1);2==e.val().length&&(7==a&&(a=8),SetSelect2Val("prod_id",a)),r()}),$(".err-reason").on("keyup",function(){$(".err-reason").closest(".form-group").removeClass("has-error")});!function(){function t(){var e=getFormData("theForm");return e.remark=$('[name="remark"]').val(),e.class_time=$('[name="class_time"]').val(),e.tblname="paper_cutwaste",e.rec_time=today(1),e.tbl=1,e.utf2gbk=["class_name","class_time","operator_captain","operator_counter","operator_guide_edge","operator_package","operator_paper_check","operator_paper_container","operator_quality_check","remark"],e}function n(){var e=getRootPath()+"/DataInterface/insert";$.ajax({url:e,type:"GET",data:t(),success:function(e){var t=$.parseJSON(e);bsTips(t.message,t.type),r(),a()},error:function(e){bsTips("数据添加失败，请稍后重试或联系管理员!",0),infoTips(JSON.stringify(e))}})}function o(){var e=getRootPath()+"/DataInterface/update",n=t();n.id=$('.portlet [type="submit"]').data("sn"),$.ajax({url:e,type:"GET",data:n,success:function(e){var t=$.parseJSON(e);bsTips(t.message,t.type),r(),a()},error:function(e){bsTips("数据更新失败，请稍后重试或联系管理员!",0),infoTips(e)}}),i.updateMode=0,$('.portlet [type="submit"]').html('提交  <i class="icon-cloud-upload"></i>')}function r(){$('.validateData input[type="text"]').val(""),$('input[name="reel_code"]').val(""),e(),$(".number").val(""),$('[name="remark"]').val("")}$("form[name=theForm]").validate({errorElement:"span",errorClass:"help-block",focusInvalid:!0,rules:{reel_code:{minlength:6,maxlength:14,number:!1,required:!0},prod_id:{required:!0},waste_num:{required:!0}},messages:{reel_code:{required:"轴号不能为空."},waste_num:{required:"切纸机废纸仓总数不能为空."},reel_weight:{required:"纸轴抄重不能为空."}},highlight:function(e){$(e).closest(".form-group").addClass("has-error")},success:function(e){e.closest(".form-group").removeClass("has-error"),e.remove()},submitHandler:function(e){}}),$('[type="submit"]').on("click",function(){$("form[name=theForm]").validate().form()?0===i.updateMode?n():o():bsTips("请确保所有必要信息均正确输入")}),$('a[name="reset"]').on("click",function(){r()})}();return $('[name="loadHisData"]').on("click",function(){o()}),$('select[name="machine_id"]').on("change",function(){var e=$('select[name="machine_id"]').val();localStorage.setItem(MAIN_KEY+"cut_machine_id",e),"帕萨班"==GetSelect2Text("machine_id")&&($('[name="ream_69"]').val(0),$('[name="ream_49"]').val(0))}),{init:function(){n(),r()}}}(),Operators=function(){function e(){var e=r();if(e){var a=s.map(function(e){return{name:e.name,value:$("[name="+e.name+"]").val()}});window.localStorage.setItem(e,JSON.stringify(a))}}function a(){var e=i(),a=window.localStorage.getItem(e);null!=a&&$('[name="class_name"]').val(a);var t=$('[name="operatorInfo"]'),n=s.map(function(e){return'<div class="col-md-12 form-group">        <label class="control-label col-md-3">'+e.title+'</label>        <div class="col-md-9">        <input type="text" placeholder="点击输入'+e.title+'信息" class="form-control" name="'+e.name+'">        </div>      </div>'}).join("");console.log(n),t.append(n),l(),$("input").on("focus",function(){$(this).select()})}function t(){$('[name="class_name"]').on("change",function(){o=$(this).val(),c()}),$('[name="saveUsers"]').on("click",function(){e()})}var n=[],o=$('[name="class_name"]').val(),r=function(){return 0!=(o=$('[name="class_name"]').val()).length&&MAIN_KEY+"_people_class_"+o},i=function(){return MAIN_KEY+"_class_name"},c=function(){var e=r();if(e){var a=i();window.localStorage.setItem(a,o);var t=window.localStorage.getItem(e);null!=t?(n=JSON.parse(t),l()):infoTips("当前班组 "+o+" 未输入过人员信息，请手动输入所有数据，下次系统将自动载入。",1)}},l=function(){n.forEach(function(e){$("[name="+e.name+"]").val(e.value)})},s=[{name:"operator_guide_edge",title:"导边"},{name:"operator_quality_check",title:"质检"},{name:"operator_paper_container",title:"纸斗"},{name:"operator_paper_check",title:"查纸"},{name:"operator_counter",title:"数数"},{name:"operator_package",title:"封包"},{name:"operator_captain",title:"机长"}];return{init:function(){t(),a(),c()}}}();jQuery(document).ready(function(){initDom(),cutWaste.init(),Operators.init()}),jQuery(window).resize(function(){HeadFix()});