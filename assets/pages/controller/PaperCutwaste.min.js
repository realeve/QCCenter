var cutWaste=function(){function e(){$('form input[type="text"]').eq(0).focus()}function t(){var e=$('[name="reelList"] tbody'),t=$('select[name="machine_id"]').val();if(null==t||""==t||t==-1)return void bsTips("请选择机台信息");var a=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=486&M=3&mid="+t;$.ajax({url:a}).done(function(t){function a(e,t){var a="<tr> <td>"+t+"</td>";return e.map(function(e){a+="  <td>"+e+"</td>"}),a+="</tr>"}t=handleAjaxData(t);var n=t.rows;if(0==n)return void bsTips("当天无相关数据");var o="";t.data.map(function(e,t){o+=a(e,t+1)}),e.html(o)})}function a(){var e=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=24&M=3&t=1&cache=14400";$.ajax({url:e}).done(function(e){var t=handleAjaxData(e);InitSelect("prod_id",t)}),e=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=23&M=3&t=1&cache=14400",$.ajax({url:e}).done(function(e){var t=handleAjaxData(e);InitSelect("machine_id",t)}),initSelect2();var a=localStorage.getItem("cut_machine_id");null!=a&&setTimeout(function(){SetSelect2Val("machine_id",a),t()},1e3)}function n(){a(),$("input[name='reel_code']").maxlength({limitReachedClass:"label label-danger",threshold:3}),$(".page-header .dropdown-quick-sidebar-toggler").hide(),e()}function o(){var e=$('input[name="reel_code"]').val(),t=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=487&M=0&r="+e,a=ReadData(t);return 0==a.rows?0:($('input[name="reel_code"]').data("reelcode",e),a.header.map(function(e){var t=e.title;$('form .form-control[name="'+t+'"]').val(a.data[0][t])}),SetSelect2Val("prod_id",a.data[0].prod_id),SetSelect2Val("machine_id",a.data[0].machine_id),$('.portlet [type="submit"]').data("sn",a.data[0].id).html('更新  <i class="icon-cloud-upload"></i>'),i.updateMode=1,bsTips("历史数据载入成功",1),1)}var i={initLoad:!0,updateMode:0};$('input[name="reel_code"]').on("blur",function(e){$(this).val().length>1?o()&&$('.portlet [type="submit"]').html('更新  <i class="icon-cloud-upload"></i>'):1==i.updateMode&&$(this).data("reelcode")!=$(this).val()&&$('.portlet [type="submit"]').html('提交  <i class="icon-cloud-upload"></i>')}),$('input[name="reel_code"]').on("keyup",function(){var e=$(this),t=jsRight(e.val(),1);2==e.val().length&&(7==t&&(t=8),SetSelect2Val("prod_id",t))}),$(".err-reason").on("keyup",function(){$(".err-reason").closest(".form-group").removeClass("has-error")});(function(){function a(){var e=getRootPath()+"/DataInterface/insert",a=getFormData("theForm");a.tblname="paper_cutwaste",a.rec_time=today(1),a.tbl=1,$.ajax({url:e,type:"GET",data:a,success:function(e){var a=$.parseJSON(e);bsTips(a.message,a.type),o(),t()},error:function(e){bsTips("数据添加失败，请稍后重试或联系管理员!",0),infoTips(JSON.stringify(e))}})}function n(){var e=getRootPath()+"/DataInterface/update",t=getFormData("theForm");t.tblname="paper_cutwaste",t.rec_time=today(1),t.tbl=1,t.id=$('.portlet [type="submit"]').data("sn"),$.ajax({url:e,type:"GET",data:t,success:function(e){var t=$.parseJSON(e);bsTips(t.message,t.type),o()},error:function(e){bsTips("数据更新失败，请稍后重试或联系管理员!",0),infoTips(e)}}),i.updateMode=0,$('.portlet [type="submit"]').html('提交  <i class="icon-cloud-upload"></i>')}function o(){$('.validateData input[type="text"]').val(""),$('input[name="reel_code"]').val(""),e(),$('input[name="waste_num"]').val("")}var r={reel_code:{minlength:6,maxlength:8,number:!1,required:!0},prod_id:{required:!0},waste_num:{required:!0}};$("form[name=theForm]").validate({errorElement:"span",errorClass:"help-block",focusInvalid:!0,rules:r,messages:{reel_code:{required:"轴号不能为空."},waste_num:{required:"切纸机废纸仓总数不能为空."}},highlight:function(e){$(e).closest(".form-group").addClass("has-error")},success:function(e){e.closest(".form-group").removeClass("has-error"),e.remove()},submitHandler:function(e){}}),$('[type="submit"]').on("click",function(){$("form[name=theForm]").validate().form()?0===i.updateMode?a():n():bsTips("请确保所有必要信息均正确输入")}),$('a[name="reset"]').on("click",function(){o()})})();return $('[name="loadHisData"]').on("click",function(){o()}),$('select[name="machine_id"]').on("change",function(){var e=$('select[name="machine_id"]').val();localStorage.setItem("cut_machine_id",e)}),{init:function(){n()}}}();jQuery(document).ready(function(){initDom(),cutWaste.init()}),jQuery(window).resize(function(){HeadFix()});