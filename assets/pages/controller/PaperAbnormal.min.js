var PaperParamAbnormal=function(){function e(){$('form input[type="text"]').eq(0).focus()}function t(){var e=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=24&M=3&t=1&cache=14400";$.ajax({url:e}).done(function(e){var t=handleAjaxData(e);InitSelect("prod_id",t)}),e=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=23&M=3&t=0&cache=14400",$.ajax({url:e}).done(function(e){var t=handleAjaxData(e);InitSelect("machine_id",t)}),e=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=25&M=3&t=4&cache=14400",$.ajax({url:e}).done(function(e){var t=handleAjaxData(e);InitSelect("oper_id",t)}),initSelect2()}function a(){$("input[name='rec_date']").val(today(6)),i(),t(),$("input[name='reel_code']").maxlength({limitReachedClass:"label label-danger",threshold:3}),$(".page-header .dropdown-quick-sidebar-toggler").hide(),$('[name="director_name"]').val("无"),e()}function n(){var e=$('[name="reel_code"]').val(),t=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=302&M=0&r="+e,a=ReadData(t);return"0"==a.rows?0:($('input[name="reelcode"]').data("reelcode",e),a.header.map(function(e){var t=e.title;$('form .form-control[name="'+t+'"]').val(a.data[0][t])}),o=a.data[0].ID,SetSelect2Val("oper_id",a.data[0].oper_id),$('[type="submit"]').html('更新 <i class="icon-cloud-upload"></i>'),void(c=1))}function r(e){var t={sur_oil_imbibition_f:{max:50,min:40,score:.5},sur_oil_imbibition_b:{max:50,min:40,score:.5},water_imbibition_f:{max:70,min:40,score:.375},water_imbibition_b:{max:70,min:40,score:.375},sur_Strength_h_f:{min:2.5,score:1},sur_Strength_h_b:{min:2.5,score:1}};e.score=100;for(var a in t)if(0!=e[a]&&""!=e[a]){var n=t[a].min;e[a]<n?e.score-=t[a].score:"undefined"!=typeof t[a].max&&e[a]>t[a].max&&(e.score-=t[a].score)}return $('[name="score"]').val(e.score),e}function i(){function e(e,t){var a="<tr>\t<td>"+t+"</td>";return e.map(function(e){a+="\t<td>"+e+"</td>"}),a+="</tr>"}var t=$('[name="hisData"] tbody'),a=$("input[name='rec_date']").val();a=jsLeft(a,7).replace("-","");var n=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=303&M=3&tstart="+a;$.ajax({url:n}).done(function(a){if(a=handleAjaxData(a),0===a.rows)return void t.html('<tr><td class="text-center" colspan='+(a.cols+1)+">指定时间内无数据</td></tr>");var n="";a.data.map(function(t,a){n+=e(t,a+1)}),t.html(n)})}var o,c=0,l=function(){jQuery().datepicker&&$(".date-picker").datepicker({rtl:App.isRTL(),orientation:"left",autoclose:!0,format:"yyyy-mm-dd"})};$('input[name="reel_code"]').on("keyup",function(){var e=$(this).val();if(e.length>1){var t=e.substr(1,1);7==t&&(t=8),SetSelect2Val("prod_id",t);var a=e.substr(2,1);SetSelect2Val("machine_id",a)}7==e.length&&n()});var m=function(){function t(e){var t,a="";return $('form[name="'+e+'"] input[type="text"]').map(function(e){a+='"'+$(this).attr("name")+'":{"number":true},'}),$('form[name="'+e+'"] select').map(function(e){a+='"'+$(this).attr("name")+'":{"min":0},'}),a="{"+jsOnRight(a,1)+"}",t=$.parseJSON(a),t.remark={require:!1,number:!1},t}function a(e){var t=getRootPath()+"/DataInterface/insert",a=getFormData("theForm");e&&(a.id=o,t=getRootPath()+"/DataInterface/update"),a.reel_code=a.reel_code.toUpperCase(),a=r(a),a.tbl=TBL.PPR_ABNORMAL,a.utf2gbk=["remark","director_name"],a.rec_time=today(1),$.ajax({url:t,type:"POST",data:a,success:function(e){var t=$.parseJSON(e);bsTips(t.message,t.type),n()},error:function(e){infoTips("保存数据失败，请稍后重试或联系管理员!",0),infoTips(JSON.stringify(e))}})}function n(){$('form input[type="text"]').val(""),SetSelect2Val("oper_id",-1),SetSelect2Val("prod_id",-1),SetSelect2Val("machine_id",-1),$(".detail input").val("0"),$("input[name='rec_date']").val(today(6)),$("input[name='temperature']").val(23),$("input[name='humidity']").val(50),$('[name="remark"]').val("无"),$('[name="director_name"]').val("无"),e()}extendValidateRule();var i=t("theForm");i.reel_code={minlength:7,maxlength:7,number:!0,required:!0},i.oper_id={required:!0,min:0},i.rec_date={number:!1},i.director_name={number:!1},$("form[name=theForm]").validate({errorElement:"span",errorClass:"help-block",focusInvalid:!0,rules:i,messages:{reel_code:{required:"轴号不能为空."},oper_id:{min:"操作人员信息不能为空"}},highlight:function(e){$(e).closest(".form-group").addClass("has-error")},success:function(e){e.closest(".form-group").removeClass("has-error"),e.remove()},submitHandler:function(e){}}),$('button[type="submit"]').on("click",function(){a(c),c&&$('[type="submit"]').html('提交 <i class="icon-cloud-upload"></i>')}),$(".detail input").on("keyup",function(e){var t=getFormData("theForm");r(t)}),$('a[name="reset"]').on("click",function(){n()})};return{init:function(){l(),a(),m()}}}();jQuery(document).ready(function(){initDom(),PaperParamAbnormal.init()}),jQuery(window).resize(function(){HeadFix()});