var PaperValidate=function(){function e(){$('form input[type="text"]').eq(0).focus()}function t(){var e=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=166&M=3&tstart="+$('[name="rec_date"]').val().replace(/-/g,"");$.ajax({url:e}).done(function(e){e=handleAjaxData(e);var t=e.data[0];t>0?bsTips("当天共有 "+t+"条数据！",1):bsTips("当天无相关数据")})}function a(){var e=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=23&M=3&t=0&cache=14400";$.ajax({url:e}).done(function(e){var t=handleAjaxData(e);InitSelect("machine_id",t)}),e=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=24&M=3&t=1&cache=14400",$.ajax({url:e}).done(function(e){var t=handleAjaxData(e);InitSelect("prod_id",t)}),e=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=23&M=3&t=1&cache=14400",$.ajax({url:e}).done(function(e){var t=handleAjaxData(e);InitSelect("cut_machine_id",t)});var e=getRootPath(1)+"/assets/pages/controller/data/paper_validate.json";$.ajax({url:e}).done(function(e){var t=e.map(function(e){return"<option>"+e.name+"</option>"});$("select[name='reel_end']").html(t.join("")),$("select[name='suspect_paper']").html(t.join("")),$("select[name='well_paper']").html(t.join(""))}),initSelect2()}function n(){$("[name=passed]").iCheck("check"),$("input[name='rec_date']").val(today(6)),a(),$("input[name='reel_code']").maxlength({limitReachedClass:"label label-danger",threshold:3}),t(),$(".page-header .dropdown-quick-sidebar-toggler").hide(),e()}function r(){var e=$('select[name="prod_id"]').val()+$('input[name="reel_code"]').val(),t=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=113&M=0&r="+e,a=ReadData(t);return 0==a.rows?0:($('input[name="reel_code"]').data("reelcode",e),a.header.map(function(e){var t=e.title;$('form .form-control[name="'+t+'"]').val(a.data[0][t])}),SetSelect2Val("prod_id",a.data[0].prod_id),SetSelect2Val("machine_id",a.data[0].machine_id),SetSelect2Val("cut_machine_id",a.data[0].cut_machine_id),SetSelect2Val("number_right",a.data[0].number_right),a.data[0].rec_date>"2017-04-26"&&(SetSelect2Val("reel_end",a.data[0].reel_end),SetSelect2Val("suspect_paper",a.data[0].suspect_paper),SetSelect2Val("well_paper",a.data[0].well_paper)),SetiCheckChecked("passed",a.data[0].passed),$('.portlet button[type="submit"]').data("sn",a.data[0].id).html('更新  <i class="icon-cloud-upload"></i>'),o.updateMode=1,bsTips("历史数据载入成功",1),1)}function i(){var e=""!==$("[name=reel_end]").val()||""!==$("[name=suspect_paper]").val()||""!==$("[name=well_paper]").val()||""!==$("[name=other]").val(),t=GetiCheckChecked("passed");return e?$(".err-reason").closest(".form-group").removeClass("has-error"):t||$(".err-reason").closest(".form-group").addClass("has-error"),e||t}var o={initLoad:!0,updateMode:0},d=function(){jQuery().datepicker&&$(".date-picker").datepicker({rtl:App.isRTL(),orientation:"left",autoclose:!0,format:"yyyy-mm-dd"})};$('input[name="reel_code"]').on("blur",function(e){$(this).val().length>1&&"-1"!==$('select[name="Prod_id"]').val()?r()&&$('.portlet button[type="submit"]').html('更新  <i class="icon-cloud-upload"></i>'):1==o.updateMode&&$(this).data("reelcode")!=$(this).val()&&$('.portlet button[type="submit"]').html('提交  <i class="icon-cloud-upload"></i>')}),$('input[name="reel_code"]').on("keyup",function(){var e=$(this),t=jsRight(e.val(),1);2==e.val().length?(7==t&&(t=8),SetSelect2Val("prod_id",t)):3==e.val().length&&SetSelect2Val("machine_id",t)}),$(".err-reason").on("keyup",function(){$(".err-reason").closest(".form-group").removeClass("has-error")}),$('input[name="cut_weight"]').on("keyup",function(){1==GetiCheckChecked("passed")&&$('input[name="package_weight"]').val($(this).val())});var c=function(){function a(){var e=getRootPath()+"/DataInterface/insert",a=getFormData("theForm");a.tbl=TBL.PPR_VALIDATE,a.utf2gbk=["reel_end","suspect_paper","well_paper","other"],a.record_Time=today(1),a.passed=GetiCheckChecked("passed"),$.ajax({url:e,type:"POST",data:a,success:function(e){var n=$.parseJSON(e);bsTips(n.message,n.type),r(),a.passed?bsTips("该轴放行，如需修改数据，请重新输入轴号载入信息",1):bsTips("该轴不放行，如需修改数据，请重新输入轴号载入信息"),t()},error:function(e){bsTips("数据添加失败，请稍后重试或联系管理员!",0),infoTips(JSON.stringify(e))}})}function n(){var e=getRootPath()+"/DataInterface/update",t=getFormData("theForm");t.tbl=TBL.PPR_VALIDATE,t.utf2gbk=["reel_end","suspect_paper","well_paper","other"],t.record_Time=today(1),t.passed=GetiCheckChecked("passed"),t.id=$('.portlet button[type="submit"]').data("sn"),$.ajax({url:e,type:"POST",data:t,success:function(e){var a=$.parseJSON(e);bsTips(a.message,a.type),r(),0==t.passed?bsTips("该轴不放行，如需修改数据，请重新输入轴号载入信息"):1==t.passed?bsTips("该轴放行，如需修改数据，请重新输入轴号载入信息",1):2==t.passed?bsTips("该轴不统计，如需修改数据，请重新输入轴号载入信息",1):3==t.passed&&bsTips("该轴待放行，如需修改数据，请重新输入轴号载入信息",1)},error:function(e){bsTips("数据更新失败，请稍后重试或联系管理员!",0),infoTips(e)}}),o.updateMode=0,$('.portlet button[type="submit"]').html('提交  <i class="icon-cloud-upload"></i>')}function r(){$('.validateData input[type="text"]').val(""),$('input[name="reel_code"]').val(""),e(),SetiCheckChecked("passed",3),$('input[name="package_weight"]').val(0)}var d={reel_code:{minlength:6,maxlength:8,number:!1,required:!0},prod_id:{required:!0},cut_weight:{required:!0},package_weight:{required:!0}};$("form[name=theForm]").validate({errorElement:"span",errorClass:"help-block",focusInvalid:!0,rules:d,messages:{reel_code:{required:"轴号不能为空."},cut_weight:{required:"切纸抄重不能为空."},package_weight:{required:"切纸抄重不能为空."}},highlight:function(e){$(e).closest(".form-group").addClass("has-error")},success:function(e){e.closest(".form-group").removeClass("has-error"),e.remove()},submitHandler:function(e){}}),$('button[type="submit"]').on("click",function(){$("form[name=theForm]").validate().form()&&i()?0===o.updateMode?a():n():bsTips("请确保所有必要信息均正确输入")}),$('a[name="reset"]').on("click",function(){r()})},s=(function(){function e(e){var t=e.data("id"),n=getRootPath()+"/DataInterface/update",r=$('[name="rec_date"]').val(),i=e.parents("tr").find("td:nth(3)").text().trim().replace(a,r);$.ajax({type:"POST",async:!1,url:n,data:{id:t,tbl:TBL.PPR_VALIDATE,rec_date:r,record_Time:i},success:function(){bsTips("该轴号日期成功更新至"+i,2),e.parents("tr").remove(),0===$('table[name="reelList"] a').length&&$('table[name="reelList"] tbody').html('<tr><td class="text-center" colspan="7">指定时间内无数据</td></tr>')},error:function(e){infoTips("日期修改失败，请联系系统管理员!",0),infoTips(JSON.stringify(e))}})}function t(){var e=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=167&M=0&tstart="+$('[name="rec_date"]').val().replace(/-/g,""),t=ReadData(e),n="";t.rows>0?(t.data.map(function(e){n+="<tr><td>"+e.ProductName+"</td><td> "+e.Machine_Name+" </td><td> "+e.reel_code+"</td><td> "+e.record_Time+"</td><td> "+e.cut_weight+"</td><td> "+e.package_weight+'</td><td><a href="javascript:;" class="btn sbold uppercase btn-outline blue" data-id='+e.ID+'><i class="fa fa-calendar-check-o"></i> 修改日期 </a></td></tr>'}),$('table[name="reelList"] tbody').html(n)):$('table[name="reelList"] tbody').html('<tr><td class="text-center" colspan="7">指定时间内无数据</td></tr>'),bsTips("历史数据载入完毕，共载入"+t.rows+"条数据",1),a=$('[name="rec_date"]').val()}$('table[name="reelList"] tbody').on("click","a",function(){e($(this))});var a;$('[name="loadHisData"]').on("click",function(){t()})}(),function(){function e(e){var t=e.data("id"),a=e.data("weight"),n=getRootPath()+"/DataInterface/update";$.ajax({type:"POST",async:!1,url:n,data:{id:t,passed:1,package_weight:a,tbl:TBL.PPR_VALIDATE},success:function(){bsTips("该轴号成功放行",2),e.parents("tr").remove(),0===$('table[name="unPassedList"] a').length&&$('table[name="unPassedList"] tbody').html('<tr><td class="text-center" colspan="7">近期所有产品均已通过检验</td></tr>')},error:function(e){infoTips("放行失败，请联系系统管理员!",0),infoTips(JSON.stringify(e))}})}return $('table[name="unPassedList"] tbody').on("click","a",function(){}),{loadUnPassedData:function(){var t=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=114&M=0";$.ajax({url:t}).done(function(e){e=handleAjaxData(e);var t='data-toggle="confirmation" data-singleton="true" data-popout="true" data-placement="left" data-title="是否放行这个轴号?" data-btn-ok-label="是" data-btn-ok-icon="fa fa-credit-card" data-btn-ok-class="btn-success" data-btn-cancel-label="取消" data-btn-cancel-icon="icon-close" data-btn-cancel-class="btn-danger"',a="";e.rows>0?(e.data.map(function(e){a+="<tr><td>"+e.ProductName+"</td><td> "+e.Machine_Name+"</td><td> "+e.cut_machine_name+" </td><td> "+e.reel_code+"</td><td> "+e.record_Time+"</td><td> "+e.cut_weight+"</td><td> "+e.package_weight+'</td><td><a href="javascript:;"'+t+' class="btn sbold uppercase btn-outline blue" data-id='+e.ID+" data-weight="+e.cut_weight+'><i class="fa fa-credit-card"></i> 放行 </a></td></tr>'}),$('table[name="unPassedList"] tbody').html(a)):$('table[name="unPassedList"] tbody').html('<tr><td class="text-center" colspan="7">近期所有产品均已通过检验</td></tr>'),$('table[name="unPassedList"] tbody a').confirmation()}),$("body").on("confirmed.bs.confirmation",'table[name="unPassedList"] tbody a',function(){e($(this))})}}}());return{init:function(){d(),n(),c(),s.loadUnPassedData()}}}();jQuery(document).ready(function(){initDom(),iCheckBoxInit(),PaperValidate.init()}),jQuery(window).resize(function(){HeadFix()});